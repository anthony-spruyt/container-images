#!/bin/bash
# Test script for megalinter-{{ flavor.name }} custom flavor
# DO NOT EDIT - Generated from flavor.yaml by megalinter-factory/generate.py
# Usage: ./test.sh <image-ref>

set -euo pipefail

IMAGE_REF="${1:?Usage: $0 <image-ref>}"

echo "=== MegaLinter {{ flavor.name | replace('-', ' ') | title }} Flavor Tests ==="
echo "Image: $IMAGE_REF"
echo ""

# Test 1: Verify all expected linters are available
echo "Test 1: Checking linter availability..."

FAILED=0

check_linter() {
  local name="$1"
  local cmd="$2"
  # shellcheck disable=SC2086 # Word splitting is intentional for command arguments
  if docker run --rm --entrypoint="" "$IMAGE_REF" $cmd >/dev/null 2>&1; then
    echo "  [PASS] $name"
  else
    echo "  [FAIL] $name"
    FAILED=$((FAILED + 1))
  fi
}

# Note: Base flavor linters are not tested - they are verified by upstream MegaLinter.
# We only test custom linters added by this flavor.
{% if custom_linters_for_test %}
# Custom linters (added by this flavor)
{% for linter in custom_linters_for_test -%}
check_linter "{{ linter.name }}" "{{ linter.version_command }}"
{% endfor %}
{% else %}
echo "  (no custom linters to test)"
{% endif -%}

echo ""

# Test 2: Verify MegaLinter flavor is set correctly
# Uses 'all' to bypass MegaLinter's flavor validation (custom names aren't recognized)
echo "Test 2: Checking MEGALINTER_FLAVOR environment variable..."
FLAVOR=$(docker run --rm --entrypoint="" "$IMAGE_REF" printenv MEGALINTER_FLAVOR 2>/dev/null || echo "NOT_SET")
if [ "$FLAVOR" = "all" ]; then
  echo "  [PASS] MEGALINTER_FLAVOR=$FLAVOR"
else
  echo "  [FAIL] MEGALINTER_FLAVOR=$FLAVOR (expected: all)"
  FAILED=$((FAILED + 1))
fi

echo ""

if [ $FAILED -gt 0 ]; then
  echo "=== $FAILED test(s) FAILED ==="
  exit 1
else
  echo "=== All tests passed ==="
fi
