---
name: Test Version Handling

on:
  # Run on PRs that modify version handling logic
  pull_request:
    paths:
      - ".github/scripts/version-handling.sh"
      - ".github/scripts/validate-configuration.sh"
      - ".github/scripts/create-release.sh"
      - ".github/scripts/test-changelog.sh"
      - ".github/scripts/test-version-fixtures.sh"
      - ".github/scripts/test-manual-version.sh"
      - ".github/workflows/image-pipeline.yaml"
      - ".github/workflows/test-version-handling.yaml"
      - "test-images/**/*"
  # Run on pushes to main
  push:
    branches:
      - main
    paths:
      - ".github/scripts/version-handling.sh"
      - ".github/scripts/validate-configuration.sh"
      - ".github/scripts/create-release.sh"
      - ".github/scripts/test-changelog.sh"
      - ".github/scripts/test-version-fixtures.sh"
      - ".github/scripts/test-manual-version.sh"
      - ".github/workflows/image-pipeline.yaml"
      - "test-images/**/*"
  # Allow manual testing with specific versions
  workflow_dispatch:
    inputs:
      test_version:
        description: "Version to test (e.g., v0.5.3, 0.5.3, viscious-llama)"
        required: false
        type: string
        default: "v0.5.3"

permissions:
  contents: read

jobs:
  test-version-handling:
    name: Test Version Handling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test all fixture images
        run: .github/scripts/test-version-fixtures.sh

      - name: Test changelog generation functions
        run: .github/scripts/test-changelog.sh

      - name: Test workflow_dispatch input (if provided)
        if: inputs.test_version
        env:
          TEST_VERSION: ${{ inputs.test_version }}
        run: .github/scripts/test-manual-version.sh "$TEST_VERSION"
