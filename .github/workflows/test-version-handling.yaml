---
name: Test Version Handling

on:
  # Run on PRs that modify version handling logic
  pull_request:
    paths:
      - ".github/scripts/version-handling.sh"
      - ".github/scripts/validate-configuration.sh"
      - ".github/scripts/create-release.sh"
      - ".github/workflows/image-pipeline.yaml"
      - ".github/workflows/test-version-handling.yaml"
      - "test-images/**/*"
  # Run on pushes to main
  push:
    branches:
      - main
    paths:
      - ".github/scripts/version-handling.sh"
      - ".github/scripts/validate-configuration.sh"
      - ".github/scripts/create-release.sh"
      - ".github/workflows/image-pipeline.yaml"
      - "test-images/**/*"
  # Allow manual testing with specific versions
  workflow_dispatch:
    inputs:
      test_version:
        description: "Version to test (e.g., v0.5.3, 0.5.3, viscious-llama)"
        required: false
        type: string
        default: "v0.5.3"

permissions:
  contents: read

jobs:
  test-version-handling:
    name: Test Version Handling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test all fixture images
        run: |
          source .github/scripts/version-handling.sh

          echo "ğŸ” Discovering test fixture images..."
          test_images=$(find test-images -name metadata.yaml -type f 2>/dev/null | sort || true)

          if [ -z "$test_images" ]; then
            echo "::error::No test fixture images found in test-images/"
            exit 1
          fi

          total=0
          passed=0
          failed=0

          for metadata_file in $test_images; do
            total=$((total + 1))
            image_dir=$(dirname "$metadata_file")
            image_name=$(basename "$image_dir")

            # Read version from metadata.yaml
            version=$(grep '^version:' "$metadata_file" | sed 's/version: *"\?\([^"]*\)"\?/\1/')

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Testing: $image_name (version: $version)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Generate tags using shared script
            generate_tags "$image_name" "$version"

            echo "  VERSION: $version"
            echo "  TAG: $TAG"
            echo "  RELEASE_TAG: $RELEASE_TAG"

            # Validate tags
            if validate_tags; then
              echo "  âœ… Tag validation passed"

              # Verify TAG has slashes converted to dashes
              expected_tag=$(echo "$version" | tr '/' '-')
              if [ "$TAG" != "$expected_tag" ]; then
                echo "  ::error::TAG conversion incorrect (expected: $expected_tag, got: $TAG)"
                failed=$((failed + 1))
                continue
              fi

              # Verify RELEASE_TAG format
              expected_release="${image_name}-${TAG}"
              if [ "$RELEASE_TAG" != "$expected_release" ]; then
                echo "  ::error::RELEASE_TAG incorrect (expected: $expected_release, got: $RELEASE_TAG)"
                failed=$((failed + 1))
                continue
              fi

              echo "  âœ… All validations passed"
              passed=$((passed + 1))
            else
              echo "  âŒ Tag validation failed"
              failed=$((failed + 1))
            fi
          done

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Test Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Total: $total"
          echo "Passed: $passed"
          echo "Failed: $failed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ $failed -gt 0 ]; then
            echo "::error::$failed test fixture(s) failed validation"
            exit 1
          fi

          echo "âœ… All $total test fixture images passed validation"

      - name: Test workflow_dispatch input (if provided)
        if: inputs.test_version
        run: |
          source .github/scripts/version-handling.sh

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Testing workflow_dispatch input: ${{ inputs.test_version }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          generate_tags "manual-test" "${{ inputs.test_version }}"

          echo "  VERSION: ${{ inputs.test_version }}"
          echo "  TAG: $TAG"
          echo "  RELEASE_TAG: $RELEASE_TAG"

          if ! validate_tags; then
            echo "::error::Manual test version validation failed"
            exit 1
          fi

          echo "âœ… Manual test version validation passed"
