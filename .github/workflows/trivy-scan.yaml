---
# yaml-language-server: $schema=https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/github-workflow.json
name: Trivy Vulnerability Scan

on:
  schedule:
    # Every day at 6:00 AM UTC
    - cron: "0 6 * * *"
  workflow_dispatch: {}

# Minimal global permissions - jobs declare their own as needed
permissions:
  contents: read

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}

jobs:
  discover-images:
    name: Discover Images
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.discover.outputs.images }}
    steps:
      # SHA pin: actions/checkout@v4.3.1
      - name: Checkout
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98

      - name: Find image directories
        id: discover
        run: |
          # Find all directories containing metadata.yaml
          IMAGES=$(find . -maxdepth 2 -name 'metadata.yaml' -type f | \
            sed 's|^\./||' | \
            sed 's|/metadata.yaml$||' | \
            grep -E '^[a-zA-Z0-9_-]+$' | \
            jq -R -s -c 'split("\n") | map(select(length > 0))')

          if [ "$IMAGES" = "[]" ] || [ -z "$IMAGES" ]; then
            echo "No images found"
            echo "images=[]" >> "$GITHUB_OUTPUT"
          else
            echo "Found images: $IMAGES"
            echo "images=$IMAGES" >> "$GITHUB_OUTPUT"
          fi

  scan-images:
    name: Scan ${{ matrix.image }}
    runs-on: ubuntu-latest
    needs: discover-images
    if: needs.discover-images.outputs.images != '[]'
    permissions:
      contents: read
      packages: read
      issues: write
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.discover-images.outputs.images) }}
    steps:
      # SHA pin: actions/checkout@v4.3.1
      - name: Checkout
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98

      - name: Log in to GHCR
        uses: docker/login-action@2e1345c05f9563db17b704b7855578af55a6c8be
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if image exists
        id: check-image
        env:
          IMAGE: ${{ matrix.image }}
        run: |
          IMAGE_REF="${REGISTRY}/${OWNER}/${IMAGE}:latest"
          if docker manifest inspect "$IMAGE_REF" > /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Image exists: $IMAGE_REF"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Image does not exist: $IMAGE_REF"
          fi

      - name: Detect Trivy configuration
        id: trivyconfig
        env:
          IMAGE: ${{ matrix.image }}
        run: |
          # Use per-image ignore file if it exists, otherwise use global
          if [ -f "${IMAGE}/.trivyignore" ]; then
            echo "ignorefile=${IMAGE}/.trivyignore" >> "$GITHUB_OUTPUT"
            echo "Using per-image ignore file: ${IMAGE}/.trivyignore"
          else
            echo "ignorefile=.trivyignore.yaml" >> "$GITHUB_OUTPUT"
            echo "Using global ignore file: .trivyignore.yaml"
          fi

          # Dev containers only need vuln scanning (secrets/misconfig caught in repo lint)
          if [[ "$IMAGE" == *-dev ]]; then
            echo "scanners=vuln" >> "$GITHUB_OUTPUT"
            echo "Scanning dev container: vuln only"
          else
            echo "scanners=vuln,secret,misconfig" >> "$GITHUB_OUTPUT"
            echo "Scanning production image: vuln,secret,misconfig"
          fi

      # SHA pin: aquasecurity/trivy-action@0.29.0
      - name: Scan image for vulnerabilities
        if: steps.check-image.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ matrix.image }}:latest
          scanners: ${{ steps.trivyconfig.outputs.scanners }}
          format: json
          output: trivy-results.json
          severity: CRITICAL,HIGH,MEDIUM
          ignore-unfixed: false
          trivyignores: ${{ steps.trivyconfig.outputs.ignorefile }}
          # Don't fail on vulnerabilities - we process results in next step
          exit-code: 0

      - name: Process results and manage issues
        if: steps.check-image.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE: ${{ matrix.image }}
        run: |
          # Parse Trivy results
          if [ ! -f trivy-results.json ]; then
            echo "No Trivy results file found"
            exit 0
          fi

          # Extract CRITICAL and HIGH vulnerabilities for table
          CRITICAL_HIGH_VULNS=$(jq -r '
            [.Results[]? | .Vulnerabilities[]? | select(.Severity == "CRITICAL" or .Severity == "HIGH") | {
              id: .VulnerabilityID,
              severity: .Severity,
              package: .PkgName,
              installed: .InstalledVersion,
              fixed: (.FixedVersion // "unfixed")
            }] | unique_by(.id)
          ' trivy-results.json)

          # Extract all vulnerabilities for counts
          ALL_VULNS=$(jq -r '
            [.Results[]? | .Vulnerabilities[]? | {
              id: .VulnerabilityID,
              severity: .Severity,
              package: .PkgName,
              installed: .InstalledVersion,
              fixed: (.FixedVersion // "unfixed")
            }] | unique_by(.id)
          ' trivy-results.json)

          TOTAL_VULN_COUNT=$(echo "$ALL_VULNS" | jq 'length')
          CRITICAL=$(echo "$ALL_VULNS" | jq '[.[] | select(.severity == "CRITICAL")] | length')
          HIGH=$(echo "$ALL_VULNS" | jq '[.[] | select(.severity == "HIGH")] | length')
          MEDIUM=$(echo "$ALL_VULNS" | jq '[.[] | select(.severity == "MEDIUM")] | length')
          ACTIONABLE_COUNT=$(echo "$CRITICAL_HIGH_VULNS" | jq 'length')

          echo "Found $TOTAL_VULN_COUNT total vulnerabilities ($ACTIONABLE_COUNT CRITICAL/HIGH, $MEDIUM MEDIUM)"

          # Search for existing open issue by title prefix
          # Use jq --arg to safely pass the image name
          EXISTING=$(gh issue list --state open --json number,title | \
            jq --arg prefix "[Trivy] $IMAGE:" -r '.[] | select(.title | startswith($prefix)) | .number' | \
            head -1)

          SCAN_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          IMAGE_REF="${REGISTRY}/${OWNER}/${IMAGE}:latest"

          if [ "$TOTAL_VULN_COUNT" -eq 0 ]; then
            echo "No vulnerabilities found"

            # Close existing issue if present
            if [ -n "$EXISTING" ]; then
              gh issue close "$EXISTING" \
                --comment "All vulnerabilities resolved as of $SCAN_DATE."
              echo "Closed issue #$EXISTING"
            fi
            exit 0
          fi

          # Build vulnerability table from CRITICAL/HIGH only
          # shellcheck disable=SC2034  # Used in heredoc below
          VULN_TABLE=$(echo "$CRITICAL_HIGH_VULNS" | jq -r '
            .[] | "| \(.id) | \(.severity) | \(.package) | \(.installed) | \(.fixed) |"
          ')

          # Create issue body with CRITICAL/HIGH table and MEDIUM summary
          BODY=$(cat <<EOF
          ## Vulnerability Scan Results

          **Image:** \`$IMAGE_REF\`
          **Scan Date:** $SCAN_DATE
          **Total:** $TOTAL_VULN_COUNT vulnerabilities ($CRITICAL CRITICAL, $HIGH HIGH, $MEDIUM MEDIUM)

          $(if [ "$ACTIONABLE_COUNT" -gt 0 ]; then
            cat <<TABLE

          ### CRITICAL and HIGH Vulnerabilities

          | CVE | Severity | Package | Installed | Fixed |
          |-----|----------|---------|-----------|-------|
          $VULN_TABLE
          TABLE
            if [ "$MEDIUM" -gt 0 ]; then
              echo ""
              echo "**Note:** $MEDIUM MEDIUM severity vulnerabilities not shown in table. [View full Trivy scan results]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)."
            fi
          fi)$(if [ "$ACTIONABLE_COUNT" -eq 0 ] && [ "$MEDIUM" -gt 0 ]; then
            cat <<MEDIUMONLY

          ### Summary

          Only MEDIUM severity vulnerabilities detected. [View full Trivy scan results]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID) for details.
          MEDIUMONLY
          fi)

          ---
          *This issue is auto-generated by the Trivy scan workflow.*
          EOF
          )

          # Build title dynamically based on severity counts
          TITLE_PARTS=()
          if [ "$CRITICAL" -gt 0 ]; then
            if [ "$CRITICAL" -eq 1 ]; then
              TITLE_PARTS+=("$CRITICAL critical vulnerability")
            else
              TITLE_PARTS+=("$CRITICAL critical vulnerabilities")
            fi
          fi
          if [ "$HIGH" -gt 0 ]; then
            if [ "$HIGH" -eq 1 ]; then
              TITLE_PARTS+=("$HIGH high vulnerability")
            else
              TITLE_PARTS+=("$HIGH high vulnerabilities")
            fi
          fi

          # Join title parts with comma, or fallback to MEDIUM if no CRITICAL/HIGH
          if [ "${#TITLE_PARTS[@]}" -gt 0 ]; then
            TITLE_TEXT=$(IFS=", "; echo "${TITLE_PARTS[*]}")
            TITLE="[Trivy] $IMAGE: $TITLE_TEXT found"
          else
            # Only MEDIUM vulnerabilities present
            if [ "$MEDIUM" -eq 1 ]; then
              TITLE="[Trivy] $IMAGE: $MEDIUM medium vulnerability found"
            else
              TITLE="[Trivy] $IMAGE: $MEDIUM medium vulnerabilities found"
            fi
          fi

          # Build labels based on severity
          LABELS="security,trivy"
          if [ "$CRITICAL" -gt 0 ]; then
            LABELS="$LABELS,critical"
          fi
          if [ "$HIGH" -gt 0 ]; then
            LABELS="$LABELS,high"
          fi
          if [ "$MEDIUM" -gt 0 ]; then
            LABELS="$LABELS,medium"
          fi

          # Ensure labels exist (create if missing)
          for label in $(echo "$LABELS" | tr ',' ' '); do
            if ! gh label list --json name -q ".[].name" | grep -qx "$label"; then
              case "$label" in
                security) gh label create "$label" --color "d73a4a" --description "Security vulnerability" ;;
                trivy)    gh label create "$label" --color "0052cc" --description "Trivy scan finding" ;;
                critical) gh label create "$label" --color "b60205" --description "Critical severity" ;;
                high)     gh label create "$label" --color "d93f0b" --description "High severity" ;;
                medium)   gh label create "$label" --color "fbca04" --description "Medium severity" ;;
              esac
            fi
          done

          if [ -n "$EXISTING" ]; then
            # Update existing issue (title, body, and labels)
            # First, remove any existing severity labels (must be separate command to avoid conflicts)
            EXISTING_SEVERITY=$(gh issue view "$EXISTING" --json labels -q '.labels[].name' | grep -E '^(critical|high|medium)$' | paste -sd, || echo "")
            if [ -n "$EXISTING_SEVERITY" ]; then
              gh issue edit "$EXISTING" --remove-label "$EXISTING_SEVERITY"
            fi
            # Then update title, body, and add current labels
            gh issue edit "$EXISTING" --title "$TITLE" --body "$BODY" --add-label "$LABELS"
            echo "Updated issue #$EXISTING"
          else
            # Create new issue with labels
            gh issue create --title "$TITLE" --body "$BODY" --label "$LABELS"
            echo "Created new issue"
          fi
