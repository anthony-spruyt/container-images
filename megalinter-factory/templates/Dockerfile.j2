# Custom MegaLinter flavor: {{ flavor.name }}
# {{ flavor.description }}
#
# DO NOT EDIT - Generated from flavor.yaml by megalinter-factory/generate.py
#
# Included linters ({{ all_linters | length }}):
# - {{ all_linters | join(', ') }}
{% if docker_binary_linters %}

# Source images for linters not in {{ flavor.base_flavor }}
{% for linter in docker_binary_linters -%}
{% if linter.image -%}
FROM {{ linter.image }} AS {{ linter.name }}
{% else -%}
FROM {{ linter.source_image }}:{{ linter.version }}{{ '@' + linter.digest if linter.digest else '' }} AS {{ linter.name }}
{% endif -%}
{% endfor %}
{%- endif %}

# Base: {{ flavor.base_flavor }} flavor from MegaLinter
{% if flavor.upstream_image -%}
FROM {{ flavor.upstream_image }}
{% else -%}
FROM oxsecurity/megalinter-{{ flavor.base_flavor }}:{{ flavor.upstream_tag }}{{ '@' + flavor.upstream_digest if flavor.upstream_digest else '' }}
{% endif -%}
{% if apk_packages %}

# Install Alpine package dependencies for custom linters
RUN apk add --no-cache {{ apk_packages | join(' ') }}
{%- endif %}
{% if docker_binary_linters %}

# Add binary linters from source images
{% for linter in docker_binary_linters -%}
COPY --link --from={{ linter.name }} {{ linter.binary_path }} {{ linter.target_path }}
{% endfor %}
{%- endif %}
{% if npm_linters %}

# Add npm-based linters (node already available in MegaLinter)
{% for pkg, info in npm_versioned_packages.items() -%}
ARG {{ info[0] | upper }}_VERSION={{ info[1] }}
{% endfor -%}
RUN npm install -g \
{%- for pkg, info in npm_versioned_packages.items() %}
    {{ pkg }}@${{ '{' }}{{ info[0] | upper }}_VERSION{{ '}' }} \
{%- endfor %}
{%- for pkg in npm_unversioned_packages %}
    {{ pkg }} \
{%- endfor %}
    && npm cache clean --force \
    && rm -rf /root/.npm/_cacache
{%- endif %}
{%- if pip_linters %}

# Add pip-based linters
{% for linter in pip_linters -%}
ARG {{ linter.name | upper }}_VERSION={{ linter.version }}
{% endfor -%}
RUN pip install --no-cache-dir{% for linter in pip_linters %} {{ linter.package }}==${{ '{' }}{{ linter.name | upper }}_VERSION{{ '}' }}{% endfor %}
{%- endif %}
{%- if go_linters %}

# Add go-based linters
{% for linter in go_linters -%}
ARG {{ linter.name | upper }}_VERSION={{ linter.version }}
RUN go install {{ linter.package }}@v${{ '{' }}{{ linter.name | upper }}_VERSION{{ '}' }}
{% endfor %}
{%- endif %}
{%- if cargo_linters %}

# Add cargo-based linters
{% for linter in cargo_linters -%}
RUN cargo install {{ linter.package }}
{% endfor %}
{%- endif %}
{%- if gem_linters %}

# Add gem-based linters (ruby already available in MegaLinter)
{% for linter in gem_linters -%}
ARG {{ linter.name | upper }}_VERSION={{ linter.version }}
{% endfor -%}
RUN gem install --no-document{% for linter in gem_linters %} {{ linter.package }}:${{ '{' }}{{ linter.name | upper }}_VERSION{{ '}' }}{% endfor %}
{%- endif %}
{%- if script_linters %}

# Add script-installed linters (using upstream MegaLinter dockerfile instructions)
{% for linter in script_linters -%}
# {{ linter.linter_key }}
{% for line in linter.dockerfile -%}
{{ line }}
{% endfor %}
{% endfor %}
{%- endif %}
{%- if flavor.extra_dockerfile %}

# Custom Dockerfile additions
{{ flavor.extra_dockerfile }}
{% endif %}

# Set flavor to 'all' to bypass MegaLinter's flavor validation
# (custom flavor names like '{{ flavor.name }}' aren't recognized by MegaLinter)
ENV MEGALINTER_FLAVOR=all
{% if npm_linters %}

# Make globally installed npm packages discoverable by ESLint
ENV NODE_PATH=/usr/lib/node_modules
{%- endif %}
